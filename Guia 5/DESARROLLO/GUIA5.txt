------------------------------
-- CASO 2
------------------------------


-- ACTIVAMOS LA SALIDA DE DBMS
SET SERVEROUTPUT ON;

-- Crear el directorio de las fotos de los clientes 

CREATE OR REPLACE DIRECTORY fotos_clientes AS 'C:\Imagenes\fotos_clientes';

-- Dar permisos desde el usuario Sys a nuestra conexi贸n
-- GRANT READ, WRITE ON DIRECTORY fotos_clientes TO GUIA5;


-------------------------------------------------

DECLARE
    -- Variables para almacenar y cargar las fotos
    v_blob BLOB;
    v_bfile BFILE;
    
    -- Identificaci贸n de la foto
    v_nombre VARCHAR2(100);

    -- Directorio donde se encuentra
    v_directorio VARCHAR2(80);
    
    -- Cursor que recorre las fotos de los Clientes
    CURSOR cur_fotos IS 
    SELECT NRO_CLIENTE, foto 
    FROM cliente 
    FOR UPDATE OF foto;

BEGIN 
    -- Recorrer el cursor y almacenar las fotos
    FOR X IN cur_fotos 
    LOOP
        BEGIN 
        
            --Directorio y nombre del archivo
            v_directorio := 'FOTOS_CLIENTES';
            v_nombre := X.NRO_CLIENTE || '.JPG';
            v_blob :=  X.foto;
            
            -- Proceso de actualizaci贸n de fotos
            v_bfile := bfilename(v_directorio, v_nombre);
            
            -- blob, bfile
            dbms_lob.OPEN(v_bfile, dbms_lob.lob_readonly);
            dbms_lob.loadfromfile(v_blob, v_bfile, dbms_lob.getlength(v_bfile));
            dbms_lob.CLOSE(v_bfile);

            DBMS_OUTPUT.PUT_LINE(v_nombre || ' ACTUALIZADO!');

        EXCEPTION 
            WHEN OTHERS THEN 
                DBMS_OUTPUT.PUT_LINE('El cliente NRO. ' || X.NRO_CLIENTE ||' no tiene foto.');
        END;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN 
        DBMS_OUTPUT.PUT_LINE('Error en el bloque an贸nimo.');
END;
/